// @codemirror/lang-markdown@6.5.0 downloaded from https://ga.jspm.io/npm:@codemirror/lang-markdown@6.5.0/dist/index.js

import{countColumn as e,EditorSelection as t,Prec as r,EditorState as n}from"@codemirror/state";import{EditorView as o,keymap as l}from"@codemirror/view";import{defineLanguageFacet as i,foldNodeProp as s,indentNodeProp as f,languageDataProp as a,foldService as m,syntaxTree as u,Language as c,LanguageDescription as h,ParseContext as p,indentUnit as g,LanguageSupport as d}from"@codemirror/language";import{CompletionContext as x}from"@codemirror/autocomplete";import{parser as k,GFM as L,Subscript as w,Superscript as A,Emoji as B,MarkdownParser as v,parseCode as b}from"@lezer/markdown";import{html as I,htmlCompletionSource as y}from"@codemirror/lang-html";import{NodeProp as C}from"@lezer/common";const S=i({commentTokens:{block:{open:"\x3c!--",close:"--\x3e"}}});const T=new C;const O=k.configure({props:[s.add((e=>!e.is("Block")||e.is("Document")||D(e)!=null||E(e)?void 0:(e,t)=>({from:t.doc.lineAt(e.from).to,to:e.to}))),T.add(D),f.add({Document:()=>null}),a.add({Document:S})]});function D(e){let t=/^(?:ATX|Setext)Heading(\d)$/.exec(e.name);return t?+t[1]:void 0}function E(e){return e.name=="OrderedList"||e.name=="BulletList"}function $(e,t){let r=e;for(;;){let e,n=r.nextSibling;if(!n||(e=D(n.type))!=null&&e<=t)break;r=n}return r.to}const q=m.of(((e,t,r)=>{for(let n=u(e).resolveInner(r,-1);n;n=n.parent){if(n.from<t)break;let e=n.type.prop(T);if(e==null)continue;let o=$(n,e);if(o>r)return{from:r,to:o}}return null}));function M(e){return new c(S,e,[],"markdown")}const P=M(O);const R=O.configure([L,w,A,B,{props:[s.add({Table:(e,t)=>({from:t.doc.lineAt(e.from).to,to:e.to})})]}]);const z=M(R);function F(e,t){return r=>{if(r&&e){let t=null;r=/\S*/.exec(r)[0];t=typeof e=="function"?e(r):h.matchLanguageName(e,r,true);if(t instanceof h)return t.support?t.support.language.parser:p.getSkippingParser(t.load());if(t)return t.parser}return t?t.parser:null}}class Context{constructor(e,t,r,n,o,l,i){this.node=e;this.from=t;this.to=r;this.spaceBefore=n;this.spaceAfter=o;this.type=l;this.item=i}blank(e,t=true){let r=this.spaceBefore+(this.node.name=="Blockquote"?">":"");if(e!=null){while(r.length<e)r+=" ";return r}for(let e=this.to-this.from-r.length-this.spaceAfter.length;e>0;e--)r+=" ";return r+(t?this.spaceAfter:"")}marker(e,t){let r=this.node.name=="OrderedList"?String(+V(this.item,e)[2]+t):"";return this.spaceBefore+r+this.type+this.spaceAfter}}function H(e,t){let r=[],n=[];for(let t=e;t;t=t.parent){if(t.name=="FencedCode")return n;t.name!="ListItem"&&t.name!="Blockquote"||r.push(t)}for(let e=r.length-1;e>=0;e--){let o,l=r[e];let i=t.lineAt(l.from),s=l.from-i.from;if(l.name=="Blockquote"&&(o=/^ *>( ?)/.exec(i.text.slice(s))))n.push(new Context(l,s,s+o[0].length,"",o[1],">",null));else if(l.name=="ListItem"&&l.parent.name=="OrderedList"&&(o=/^( *)\d+([.)])( *)/.exec(i.text.slice(s)))){let e=o[3],t=o[0].length;if(e.length>=4){e=e.slice(0,e.length-4);t-=4}n.push(new Context(l.parent,s,s+t,o[1],e,o[2],l))}else if(l.name=="ListItem"&&l.parent.name=="BulletList"&&(o=/^( *)([-+*])( {1,4}\[[ xX]\])?( +)/.exec(i.text.slice(s)))){let e=o[4],t=o[0].length;if(e.length>4){e=e.slice(0,e.length-4);t-=4}let r=o[2];o[3]&&(r+=o[3].replace(/[xX]/," "));n.push(new Context(l.parent,s,s+t,o[1],e,r,l))}}return n}function V(e,t){return/^(\s*)(\d+)(?=[.)])/.exec(t.sliceString(e.from,e.from+10))}function X(e,t,r,n=0){for(let o=-1,l=e;;){if(l.name=="ListItem"){let e=V(l,t);let i=+e[2];if(o>=0){if(i!=o+1)return;r.push({from:l.from+e[1].length,to:l.from+e[0].length,insert:String(o+2+n)})}o=i}let e=l.nextSibling;if(!e)break;l=e}}function K(t,r){let n=/^[ \t]*/.exec(t)[0].length;if(!n||r.facet(g)!="\t")return t;let o=e(t,4,n);let l="";for(let e=o;e>0;)if(e>=4){l+="\t";e-=4}else{l+=" ";e--}return l+t.slice(n)}const N=(r={})=>({state:n,dispatch:o})=>{let l=u(n),{doc:i}=n;let s=null,f=n.changeByRange((o=>{if(!o.empty||!z.isActiveAt(n,o.from,-1)&&!z.isActiveAt(n,o.from,1))return s={range:o};let f=o.from,a=i.lineAt(f);let m=H(l.resolveInner(f,-1),i);while(m.length&&m[m.length-1].from>f-a.from)m.pop();if(!m.length)return s={range:o};let u=m[m.length-1];if(u.to-u.spaceAfter.length>f-a.from)return s={range:o};let c=f>=u.to-u.spaceAfter.length&&!/\S/.test(a.text.slice(u.to));if(u.item&&c){let e=u.node.firstChild,o=u.node.getChild("ListItem","ListItem");if(e.to>=f||o&&o.to<f||a.from>0&&!/[^\s>]/.test(i.lineAt(a.from-1).text)||r.nonTightLists===false){let e=m.length>1?m[m.length-2]:null;let r,n="";if(e&&e.item){r=a.from+e.from;n=e.marker(i,1)}else r=a.from+(e?e.to:0);let o=[{from:r,to:f,insert:n}];u.node.name=="OrderedList"&&X(u.item,i,o,-2);e&&e.node.name=="OrderedList"&&X(e.item,i,o);return{range:t.cursor(r+n.length),changes:o}}{let e=G(m,n,a);return{range:t.cursor(f+e.length+1),changes:{from:a.from,insert:e+n.lineBreak}}}}if(u.node.name=="Blockquote"&&c&&a.from){let e=i.lineAt(a.from-1),t=/>\s*$/.exec(e.text);if(t&&t.index==u.from){let r=n.changes([{from:e.from+t.index,to:e.to},{from:a.from+u.from,to:a.to}]);return{range:o.map(r),changes:r}}}let h=[];u.node.name=="OrderedList"&&X(u.item,i,h);let p=u.item&&u.item.from<a.from;let g="";if(!p||/^[\s\d.)\-+*>]*/.exec(a.text)[0].length>=u.to)for(let t=0,r=m.length-1;t<=r;t++)g+=t!=r||p?m[t].blank(t<r?e(a.text,4,m[t+1].from)-g.length:null):m[t].marker(i,1);let d=f;while(d>a.from&&/\s/.test(a.text.charAt(d-a.from-1)))d--;g=K(g,n);j(u.node,n.doc)&&(g=G(m,n,a)+n.lineBreak+g);h.push({from:d,to:f,insert:n.lineBreak+g});return{range:t.cursor(d+g.length+1),changes:h}}));if(s)return false;o(n.update(f,{scrollIntoView:true,userEvent:"input"}));return true};const Q=N();function U(e){return e.name=="QuoteMark"||e.name=="ListMark"}function j(e,t){if(e.name!="OrderedList"&&e.name!="BulletList")return false;let r=e.firstChild,n=e.getChild("ListItem","ListItem");if(!n)return false;let o=t.lineAt(r.to),l=t.lineAt(n.from);let i=/^[\s>]*$/.test(o.text);return o.number+(i?0:1)<l.number}function G(t,r,n){let o="";for(let r=0,l=t.length-2;r<=l;r++)o+=t[r].blank(r<l?e(n.text,4,t[r+1].from)-o.length:null,r<l);return K(o,r)}function J(e,t){let r=e.resolveInner(t,-1),n=t;if(U(r)){n=r.from;r=r.parent}for(let e;e=r.childBefore(n);)if(U(e))n=e.from;else{if(e.name!="OrderedList"&&e.name!="BulletList")break;r=e.lastChild;n=r.to}return r}const W=({state:r,dispatch:n})=>{let o=u(r);let l=null,i=r.changeByRange((n=>{let i=n.from,{doc:s}=r;if(n.empty&&z.isActiveAt(r,n.from)){let n=s.lineAt(i);let l=H(J(o,i),s);if(l.length){let o=l[l.length-1];let s=o.to-o.spaceAfter.length+(o.spaceAfter?1:0);if(i-n.from>s&&!/\S/.test(n.text.slice(s,i-n.from)))return{range:t.cursor(n.from+s),changes:{from:n.from+s,to:i}};if(i-n.from==s&&(!o.item||n.from<=o.item.from||!/\S/.test(n.text.slice(0,o.to)))){let l=n.from+o.from;if(o.item&&o.node.from<o.item.from&&/\S/.test(n.text.slice(o.from,o.to))){let i=o.blank(e(n.text,4,o.to)-e(n.text,4,o.from));l==n.from&&(i=K(i,r));return{range:t.cursor(l+i.length),changes:{from:l,to:n.from+o.to,insert:i}}}if(l<i)return{range:t.cursor(l),changes:{from:l,to:i}}}}}return l={range:n}}));if(l)return false;n(r.update(i,{scrollIntoView:true,userEvent:"delete"}));return true};const Y=[{key:"Enter",run:Q},{key:"Backspace",run:W}];const Z=I({matchClosingTags:false});function _(e={}){let{codeLanguages:t,defaultCodeLanguage:n,addKeymap:o=true,base:{parser:i}=P,completeHTMLTags:s=true,pasteURLAsLink:f=true,htmlTagLanguage:a=Z}=e;if(!(i instanceof v))throw new RangeError("Base parser provided to `markdown` should be a Markdown parser");let m=e.extensions?[e.extensions]:[];let u,c=[a.support,q];f&&c.push(oe);if(n instanceof d){c.push(n.support);u=n.language}else n&&(u=n);let h=t||u?F(t,u):void 0;m.push(b({codeParser:h,htmlParser:a.language.parser}));o&&c.push(r.high(l.of(Y)));let p=M(i.configure(m));s&&c.push(p.data.of({autocomplete:ee}));return new d(p,c)}function ee(e){let{state:t,pos:r}=e,n=/<[:\-\.\w\u00b7-\uffff]*$/.exec(t.sliceDoc(r-25,r));if(!n)return null;let o=u(t).resolveInner(r,-1);while(o&&!o.type.isTop){if(o.name=="CodeBlock"||o.name=="FencedCode"||o.name=="ProcessingInstructionBlock"||o.name=="CommentBlock"||o.name=="Link"||o.name=="Image")return null;o=o.parent}return{from:r-n[0].length,to:r,options:re(),validFor:/^<[:\-\.\w\u00b7-\uffff]*$/}}let te=null;function re(){if(te)return te;let e=y(new x(n.create({extensions:Z}),0,true));return te=e?e.options:[]}const ne=/code|horizontalrule|html|link|comment|processing|escape|entity|image|mark|url/i;const oe=o.domEventHandlers({paste:(e,t)=>{var r;let{main:n}=t.state.selection;if(n.empty)return false;let o=(r=e.clipboardData)===null||r===void 0?void 0:r.getData("text/plain");if(!o||!/^(https?:\/\/|mailto:|xmpp:|www\.)/.test(o))return false;/^www\./.test(o)&&(o="https://"+o);if(!z.isActiveAt(t.state,n.from,1))return false;let l=u(t.state),i=false;l.iterate({from:n.from,to:n.to,enter:e=>{(e.from>n.from||ne.test(e.name))&&(i=true)},leave:e=>{e.to<n.to&&(i=true)}});if(i)return false;t.dispatch({changes:[{from:n.from,insert:"["},{from:n.to,insert:`](${o})`}],userEvent:"input.paste",scrollIntoView:true});return true}});export{P as commonmarkLanguage,W as deleteMarkupBackward,Q as insertNewlineContinueMarkup,N as insertNewlineContinueMarkupCommand,_ as markdown,Y as markdownKeymap,z as markdownLanguage,oe as pasteURLAsLink};

